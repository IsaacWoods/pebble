<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RISC-V - Poplar</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../kernel/index.html"><strong aria-hidden="true">2.</strong> The Kernel</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/platforms.html"><strong aria-hidden="true">2.1.</strong> Platforms</a></li><li class="chapter-item expanded "><a href="../kernel/efiloader.html"><strong aria-hidden="true">2.2.</strong> Efiloader</a></li><li class="chapter-item expanded "><a href="../kernel/kernel_objects.html"><strong aria-hidden="true">2.3.</strong> Kernel Objects</a></li><li class="chapter-item expanded "><a href="../kernel/syscalls.html"><strong aria-hidden="true">2.4.</strong> System calls</a></li><li class="chapter-item expanded "><a href="../kernel/debugging.html"><strong aria-hidden="true">2.5.</strong> Debugging the kernel</a></li></ol></li><li class="chapter-item expanded "><a href="../syscalls/index.html"><strong aria-hidden="true">3.</strong> Syscalls</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../syscalls/yield.html"><strong aria-hidden="true">3.1.</strong> yield</a></li><li class="chapter-item expanded "><a href="../syscalls/early_log.html"><strong aria-hidden="true">3.2.</strong> early_log</a></li><li class="chapter-item expanded "><a href="../syscalls/get_framebuffer.html"><strong aria-hidden="true">3.3.</strong> get_framebuffer</a></li><li class="chapter-item expanded "><a href="../syscalls/create_memory_object.html"><strong aria-hidden="true">3.4.</strong> create_memory_object</a></li><li class="chapter-item expanded "><a href="../syscalls/map_memory_object.html"><strong aria-hidden="true">3.5.</strong> map_memory_object</a></li><li class="chapter-item expanded "><a href="../syscalls/create_channel.html"><strong aria-hidden="true">3.6.</strong> create_channel</a></li><li class="chapter-item expanded "><a href="../syscalls/send_message.html"><strong aria-hidden="true">3.7.</strong> send_message</a></li><li class="chapter-item expanded "><a href="../syscalls/get_message.html"><strong aria-hidden="true">3.8.</strong> get_message</a></li><li class="chapter-item expanded "><a href="../syscalls/register_service.html"><strong aria-hidden="true">3.9.</strong> register_service</a></li><li class="chapter-item expanded "><a href="../syscalls/subscribe_to_service.html"><strong aria-hidden="true">3.10.</strong> subscribe_to_service</a></li><li class="chapter-item expanded "><a href="../syscalls/pci_get_info.html"><strong aria-hidden="true">3.11.</strong> pci_get_info</a></li></ol></li><li class="chapter-item expanded "><a href="../userspace/index.html"><strong aria-hidden="true">4.</strong> Userspace</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../userspace/capabilities.html"><strong aria-hidden="true">4.1.</strong> Capabilities</a></li><li class="chapter-item expanded "><a href="../userspace/memory_map_x86_64.html"><strong aria-hidden="true">4.2.</strong> Memory map (x86_64)</a></li></ol></li><li class="chapter-item expanded "><a href="../message_passing/index.html"><strong aria-hidden="true">5.</strong> Message Passing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../message_passing/wire_format.html"><strong aria-hidden="true">5.1.</strong> Ptah wire format</a></li></ol></li><li class="chapter-item expanded "><a href="../journal/index.html"><strong aria-hidden="true">6.</strong> Journal</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../journal/rustc_target.html"><strong aria-hidden="true">6.1.</strong> Building a rustc target for Poplar</a></li><li class="chapter-item expanded "><a href="../journal/usb.html"><strong aria-hidden="true">6.2.</strong> USB</a></li><li class="chapter-item expanded "><a href="../journal/riscv.html" class="active"><strong aria-hidden="true">6.3.</strong> RISC-V</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Poplar</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="risc-v"><a class="header" href="#risc-v">RISC-V</a></h1>
<h3 id="building-opensbi"><a class="header" href="#building-opensbi">Building OpenSBI</a></h3>
<p>OpenSBI is the reference implementation for the Supervisor Binary Interface (SBI). It's basically how you access
M-mode functionality from your S-mode bootloader or kernel.</p>
<p>Firstly, we need a RISC-V C toolchain. On Arch, I installed the <code>riscv64-unknown-elf-binutils</code> AUR package. I also
tried to install the <code>riscv64-unknown-elf-gcc</code> package, but this wouldn't work, so I built OpenSBI with Clang+LLVM
instead with (from inside <code>lib/opensbi</code>):</p>
<pre><code>make PLATFORM=generic LLVM=1
</code></pre>
<p>This can be tested on QEMU with:</p>
<pre><code>qemu-system-riscv64 -M virt -bios build/platform/generic/firmware/fw_jump.elf
</code></pre>
<p>It also seems like you can build with a platform of <code>qemu/virt</code> - I'm not sure what difference this makes yet
but guessing it's the hardware it assumes it needs to drive? Worth exploring. (Apparently the <code>generic</code> image is
doing dynamic discovery (I'm assuming from the device tree) so that sounds good for now).</p>
<p>So the jump firmware (<code>fw_jump.elf</code>) jumps to a specified address in memory (apparently QEMU can load an ELF which
would be fine initially). Other option would be a payload firmware, which bundles your code into the SBI image
(assuming as a flat binary) and executes it like that.</p>
<p>We should probably make an <code>xtask</code> step to build OpenSBI and move it to the <code>bundled</code> directory, plus decide what
sort of firmware / booting strategy we're going to use. Then the next step would be some Rust code that can print
to the serial port, to prove it's all working.</p>
<h3 id="qemu-virt-memory-map"><a class="header" href="#qemu-virt-memory-map">QEMU <code>virt</code> memory map</a></h3>
<p>Seems everything is memory-mapped, which makes for a nice change coming from x86's nasty port thingy. This is the
<code>virt</code> machine's one (from the QEMU source...):</p>
<div class="table-wrapper"><table><thead><tr><th>Region</th><th>Address</th><th>Size</th></tr></thead><tbody>
<tr><td>Debug</td><td><code>0x0</code></td><td><code>0x100</code></td></tr>
<tr><td>MROM</td><td><code>0x1000</code></td><td><code>0x11000</code></td></tr>
<tr><td>Test</td><td><code>0x100000</code></td><td><code>0x1000</code></td></tr>
<tr><td>CLINT</td><td><code>0x0200_0000</code></td><td><code>0x10000</code></td></tr>
<tr><td>PCIe PIO</td><td><code>0x0300_0000</code></td><td><code>0x10000</code></td></tr>
<tr><td>PLIC</td><td><code>0x0c00_0000</code></td><td><code>0x4000000</code></td></tr>
<tr><td>UART0</td><td><code>0x1000_0000</code></td><td><code>0x100</code></td></tr>
<tr><td>Virtio</td><td><code>0x1000_1000</code></td><td><code>0x1000</code></td></tr>
<tr><td>Flash</td><td><code>0x2000_0000</code></td><td><code>0x4000000</code></td></tr>
<tr><td>PCIe ECAM</td><td><code>0x3000_0000</code></td><td><code>0x10000000</code></td></tr>
<tr><td>PCIe MMIO</td><td><code>0x4000_0000</code></td><td><code>0x40000000</code></td></tr>
<tr><td>DRAM</td><td><code>0x8000_0000</code></td><td><code>{mem size}</code></td></tr>
</tbody></table>
</div>
<h3 id="getting-control-from-opensbi"><a class="header" href="#getting-control-from-opensbi">Getting control from OpenSBI</a></h3>
<p>On QEMU, we can get control from OpenSBI by linking a binary at <code>0x80200000</code>, and then using <code>-kernel</code> to
automatically load it at the right location. OpenSBI will then jump to this location with the HART ID in <code>a0</code> and
a pointer to the device tree in <code>a1</code>.</p>
<p>However, this does make setting paging up slightly icky, as has been a problem on other architectures. Basically,
the first binary needs to be linked at a low address with bare translation, and then we need to construct page
tables and enable translation, then jump to a higher address. I'm thinking we might as well do it in two stages:
a Seed stage that loads the kernel and early tasks from the filesystem/network/whatever, builds the kernel page
tables, and then enters the kernel and can be unloaded at a later date. The kernel can then be linked normally at
its high address without faffing around with a bootstrap or anything.</p>
<h3 id="the-device-tree"><a class="header" href="#the-device-tree">The device tree</a></h3>
<p>So the device tree seems to be a data structure passed to you that tells you about the hardware present / memory
etc. Hopefully it's less gross than ACPI eh. Repnop has written <a href="https://docs.rs/fdt/0.1.3/fdt/">a crate, <code>fdt</code></a>,
so I think we're just going to use that.</p>
<p>So <code>fdt</code> seems to work fine, we can list memory regions etc. The only issue seems to be that <code>memory_reservations</code>
doesn't return anything, which is kind of weird. There also seems to be a <code>/reserved-memory</code> node, but <a href="https://github.com/devicetree-org/devicetree-specification/blob/master/source/chapter3-devicenodes.rst#reserved-memory-and-uefi">this</a>
suggests that this doesn't include stuff we want like which part of memory OpenSBI resides in.</p>
<p><a href="https://github.com/riscv-software-src/opensbi/issues/70">This issue</a> says Linux just assumes it shouldn't touch
anything before it was loaded. I guess we could use the same approach, reserving the memory used by Seed via linker
symbols, and then seeing where the <code>loader</code> device gets put to reserve the ramdisk, but the issue was closed saying
OpenSBI now does the reservations correctly which would be cleaner, but doesn't stack up with what we're seeing.</p>
<p>Ah so actually, <code>/reserved-memory</code> does seem to have some of what we need. On QEMU there is one child node, called
<code>mmode_resv@80000000</code>, which would fit with being the memory OpenSBI is in. We would still need to handle the
memory we're in, and idk what happens with the <code>loader</code> device yet, but it's a start. Might be worth talking to
repnop about whether the crate should use this node.</p>
<h3 id="dumb-way-to-load-the-kernel-for-now"><a class="header" href="#dumb-way-to-load-the-kernel-for-now">Dumb way to load the kernel for now</a></h3>
<p>So for some reason, <code>fw_cfg</code> doesn't seem to be working on QEMU 7.1. This is what we were gonna use for loading the
kernel, command line, and user programs, etc. but obvs this is not possible atm. For now, as a workaround, we can
use the <code>loader</code> device to load arbitrary data and files into memory.</p>
<p>I'm thinking we could use <code>0x1_0000_0000</code> as the base physical address for this - this gives us a maximum of 2GiB
of DRAM, which seems plenty for now (famous last words). We'll need to know the size of the object we're loading on
the guest-side, so we'll load that separately for now (in the future, this whole scheme could be extended to some
sort of mini-filesystem).</p>
<p>Okay so the <code>loader</code> device is pretty finnicky, and has no error handling. Turns out you can't define new memory
with it, just load values into RAM, but it doesn't actually tell you this has failed. You then try and read this
on the guest, and get super wierd UB from doing so - it doesn't just fault or whatever, it seems to break code
before you ever read the memory (super weird ngl, didn't stick around to work out what was going on).</p>
<p>Right, seems to be working much better by actually putting the values in RAM. We've extended RAM to 1GiB
(<code>0x8000_0000..0xc000_0000</code>) and we'll use this as the new layout:</p>
<div class="table-wrapper"><table><thead><tr><th>Address</th><th>Description</th><th>Size (bytes)</th></tr></thead><tbody>
<tr><td>0xb000_0000</td><td>Size of Data</td><td>4</td></tr>
<tr><td>0xb000_0004</td><td>Data</td><td>N</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../journal/usb.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../journal/usb.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
