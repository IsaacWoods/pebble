<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Message Passing - Poplar</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Poplar</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="message-passing"><a class="header" href="#message-passing">Message Passing</a></h1>
<p>Poplar has a kernel object called a <code>Channel</code> for providing first-class message passing support to userspace.
Channels move packets, called "messages", which contain a stream of bytes, and optionally one or more handles that
are transferred from the sending task to the receiving task.</p>
<h3 id="ptah"><a class="header" href="#ptah">Ptah</a></h3>
<p>Channels can move arbitrary bytes, but Poplar also includes a layer on top of Channels called Ptah, which
consists of a data model and wire format suitable for encoding data which can be serialized and deserialized from
any sensible language without too much difficulty.</p>
<p>Ptah is used for IPC between tasks running in userspace, and also for more complex communication between the kernel
and userspace.</p>
<p>Ptah is heavily inspired by <a href="https://serde.rs">Serde</a>, and the first implementation of Ptah was actually a <a href="https://github.com/IsaacWoods/poplar/tree/04f3eed45a40f196a02374ca053aaee16517dccb/lib/ptah">Serde
data format</a>.
Unfortunately, it made properly handling Poplar handles very difficult - when a handle is sent over a channel, it
needs to be put into a separate array, and the in-line data replaced by an index into that array.  When the message
travels over a task boundary, the kernel examines and replaces each handle in this array with a handle to the same
kernel object in the new task. This effectively means we need to add a new <code>Handle</code> type to our data model, which
is not easily possible with Serde (and would make it incompatible with standard Serde serializers anyway).</p>
<h3 id="the-ptah-data-model"><a class="header" href="#the-ptah-data-model">The Ptah Data Model</a></h3>
<p>The Ptah data model maps pretty well to the Rust type system, and relatively closely to the Serde data model. Key
differences are some stronger guarantees about the encoding of types such as enums (the data model only needs to
fit a single wire format, and so can afford to be less flexible than Serde's), and the lack of a few types -
<code>unit</code>-based types, and the statically-sized version of <code>seq</code> and <code>map</code> - <code>tuple</code> and <code>struct</code>. Ptah is not a
self-describing format (i.e. the type you're trying to (de)serialize must be known at both ends), so the elements
of structs and tuples can simply be serialized in the order they appear, and then deserialized in order at the
other end.</p>
<ul>
<li>Primitive types
<ul>
<li><code>bool</code></li>
<li><code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>u128</code></li>
<li><code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>i128</code></li>
<li><code>f32</code>, <code>f64</code></li>
<li><code>char</code></li>
</ul>
</li>
<li><code>string</code>
<ul>
<li>Encoded as a <code>seq</code> of <code>u8</code>, but with the additional requirement that it is valid UTF-8</li>
<li>Not null terminated, as <code>seq</code> includes explicit length</li>
</ul>
</li>
<li><code>option</code>
<ul>
<li>Encoded in the same way as an enum, but separately for the benefit of languages without proper enums</li>
<li>Either <code>None</code> or <code>Some({value})</code></li>
</ul>
</li>
<li><code>enum</code>
<ul>
<li>Include a tag, and optionally some data</li>
<li>Represent a Rust <code>enum</code>, or a tagged union in languages without proper enums</li>
<li>The data is encoded separately to the tag, and can be of any other Ptah type:
<ul>
<li>Rust tuple variants (e.g. <code>E::A(u8, u32)</code>) are represented by <code>tuple</code></li>
<li>Rust struct variants (e.g. <code>E::B { foo: u8, bar: u32 }</code>) are represented by <code>struct</code></li>
</ul>
</li>
</ul>
</li>
<li><code>seq</code>
<ul>
<li>A variable-length sequence of values, mapping to types such as arrays and <code>Vec&lt;T&gt;</code>.</li>
</ul>
</li>
<li><code>map</code>
<ul>
<li>A variable-length series of key-value pairings, mapping to collections like <code>BTreeMap&lt;K, V&gt;</code>.</li>
</ul>
</li>
<li><code>handle</code>
<ul>
<li>A marker in the data stream that a handle to a kernel object is being moved across the channel. The handle itself is encoded out-of-band.</li>
<li>This allows the kernel, or something else handling Ptah-encoded data, to process the handle</li>
<li>Handles being first-class in the data model is why Poplar can't readily use something like <code>serde</code></li>
</ul>
</li>
</ul>
<h3 id="the-ptah-wire-format"><a class="header" href="#the-ptah-wire-format">The Ptah Wire Format</a></h3>
<p>The wire format describes how messages can be encoded into a stream of bytes suitable for transmission over a
channel, or over another transport layer such as the network or a serial port.</p>
<p>Primitives are transmitted as little-endian and packed to their natural alignment. The following primitive types
are recognised:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Size (bytes)</th><th>Description</th></tr></thead><tbody>
<tr><td><code>bool</code></td><td>1</td><td>A boolean value</td></tr>
<tr><td><code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>u128</code></td><td>1, 2, 4, 8</td><td>An unsigned integer</td></tr>
<tr><td><code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>i128</code></td><td>1, 2, 4, 8</td><td>A signed integer</td></tr>
<tr><td><code>f32</code>, <code>f64</code></td><td>4, 8</td><td>Single / double-precision IEEE-754 FP values</td></tr>
<tr><td><code>char</code></td><td>4</td><td>A single UTF-8 Unicode scalar value</td></tr>
</tbody></table>
</div>
<p>TODO: rest of the wire format</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="kernel/debugging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="userspace/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="kernel/debugging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="userspace/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
