<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This module implements a buddy allocator, an efficient scheme for managing physical memory. In this allocator, memory is broken up into a number of blocks, each of which is a power-of-2 frames in size. A block of size `2^^n` frames is said to be of order `n`:"><title>kernel::memory::buddy_allocator - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-9ee3a5e31a2afa3e.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="kernel" data-themes="" data-resource-suffix="" data-rustdoc-version="1.76.0-nightly (2f8d81f9d 2023-11-21)" data-channel="nightly" data-search-js="search-21db098bdc95be9e.js" data-settings-js="settings-74424d7eec62a23e.js" ><script src="../../../static.files/storage-fec3eaa3851e447d.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-f06f02fd918e3bb3.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-5d8b3c7633ad77ba.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../kernel/index.html">kernel</a><span class="version">0.1.0</span></h2></div><h2 class="location"><a href="#">Module buddy_allocator</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#constants">Constants</a></li></ul></section><h2><a href="../index.html">In kernel::memory</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‚ÄòS‚Äô to search, ‚Äò?‚Äô for more options‚Ä¶" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">kernel</a>::<wbr><a href="../index.html">memory</a>::<wbr><a class="mod" href="#">buddy_allocator</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../../../src/kernel/memory/buddy_allocator.rs.html#1-388">source</a> ¬∑ <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This module implements a buddy allocator, an efficient scheme for managing physical memory. In
this allocator, memory is broken up into a number of blocks, each of which is a power-of-2 frames in
size. A block of size <code>2^^n</code> frames is said to be of order <code>n</code>:</p>

<div class="example-wrap ignore"><a href="#" class="tooltip" title="This example is not tested">‚ìò</a><pre class="rust rust-example-rendered"><code>      <span class="number">16                               0       </span>Order       Size of blocks
       |-------------------------------|
       |               <span class="number">8               </span>|       <span class="number">4           2</span>^^<span class="number">4 </span>= <span class="number">16
       </span>|---------------|---------------|
       |      <span class="number">12       </span>|       <span class="number">4       </span>|       <span class="number">3           2</span>^^<span class="number">3 </span>= <span class="number">8
       </span>|-------|-------|-------|-------|
       |  <span class="number">14   </span>|  <span class="number">10   </span>|   <span class="number">6   </span>|   <span class="number">2   </span>|       <span class="number">2           2</span>^^<span class="number">2 </span>= <span class="number">4
       </span>|---|---|---|---|---|---|---|---|
       |   |   |   |   |   |   |   |   |       <span class="number">1           2</span>^^<span class="number">1 </span>= <span class="number">2
       </span>|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|
       | | | | | | | | | | | | | | | | |       <span class="number">0           2</span>^^<span class="number">0 </span>= <span class="number">1
       </span>|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|</code></pre></div>
<p>The blocks in each order are arranged in pairs - each has a ‚Äúbuddy‚Äù where A‚Äôs buddy is B and B‚Äôs
buddy is A. To find the address of a block‚Äôs buddy, the bit corresponding to the order is simply
flipped (and so is easily calculated with XOR - see the <code>buddy_of</code> method). Blocks are tracked in
bins, where each bin contains blocks of a single order.</p>
<p>When an allocation is requested, the allocator looks in the bin of the correct size. If a block
is available, that block is removed from the bin and returned. If no blocks of the correct size
are available, a block of the order above the one requested is removed from its bin, split into
two blocks of the order requested (which are ‚Äúbuddies‚Äù of each other), of which one is returned
and one is added to the correct bin. If no blocks of the larger order are available, this
process continues recursively upwards to larger and larger block sizes, until a free block is
found. If no block is found, an ‚Äúout of memory‚Äù error is issued.</p>
<p>When a block is ‚Äúfreed‚Äù (returned to the allocator so that it can be allocated again), the
allocator checks to see if its ‚Äúbuddy‚Äù is also free. If it‚Äôs not, the block is just added to the
bin corresponding to its order. However, if its buddy is also free, the two can be merged to form
a block of an order one greater - this process happens recursively until the block‚Äôs buddy is not
free, at which point the block is added to the correct bin.</p>
<p>Overall, the buddy allocator is an efficient allocator that has a much lower cost than other
algorithms such as first-fit. It also helps reduce external fragmentation, but can suffer from
internal fragmentation in the case of allocations that are slightly larger than a block size
(e.g. allocating 17 frames actually returns 32, wasting 15 frames). If the kernel needs to make
many allocations of a constant, ‚Äúknown bad‚Äù size (e.g. 3 frames at a time), it would be better
served allocating a larger block of frames at a time, and using a slab allocator to make the
individual allocations.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.BuddyAllocator.html" title="struct kernel::memory::buddy_allocator::BuddyAllocator">BuddyAllocator</a></div></li></ul><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.BASE_SIZE.html" title="constant kernel::memory::buddy_allocator::BASE_SIZE">BASE_SIZE</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">The ‚Äúbase‚Äù block size - the smallest block size this allocator tracks. This is chosen at the moment to be
<code>4096</code> bytes - the size of the smallest physical frame for all the architectures we wish to support at this
point of time.</div></li><li><div class="item-name"><a class="constant" href="constant.MAX_ORDER.html" title="constant kernel::memory::buddy_allocator::MAX_ORDER">MAX_ORDER</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">The largest block stored by the buddy allocator is <code>2^MAX_ORDER</code>.</div></li><li><div class="item-name"><a class="constant" href="constant.NUM_BINS.html" title="constant kernel::memory::buddy_allocator::NUM_BINS">NUM_BINS</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li></ul></section></div></main></body></html>